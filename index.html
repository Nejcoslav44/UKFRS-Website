<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UK Duty Hours Tracker</title>

<style>
  :root{
    --text:#e9ecf5;
    --muted:#aeb7d3;
    --radius:18px;
    --mono: ui-monospace, Consolas, monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;

    --rowRedBg: rgba(255, 90, 90, 0.16);
    --rowRedBorder: rgba(255, 90, 90, 0.35);
    --rowGreenBg: rgba(124, 255, 167, 0.16);
    --rowGreenBorder: rgba(124, 255, 167, 0.35);

    /* per-division accents (overridden by body class) */
    --accentBg: #ff2b2b;
    --accentText: #ffffff;

    /* HOME background image (set to your actual file) */
    --homeBgImage: url("F999_photo.jpg");
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--sans);
    color:var(--text);
    background:#000;
    overflow-x:hidden;
  }

  /* ===== LIVE BACKGROUND VIDEO ===== */
  .bg-video-wrap{
    position:fixed;
    inset:0;
    z-index:-5;
    overflow:hidden;
    background:#000;
  }
  .bg-video{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    object-position: center 20%;
    filter:none;
  }

  /* ===== HOME BG IMAGE ===== */
  .home-bg{
    position:fixed;
    inset:0;
    z-index:-5;
    background:
      linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.58)),
      var(--homeBgImage);
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
  }

  /* ===== LAYOUT ===== */
  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:42px 18px 64px;
    position:relative;
    z-index:1;
  }

  .top{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
    margin-bottom:18px;
  }
  .brand h1{margin:0;font-size:28px;}
  .brand p{margin:6px 0 0;color:var(--muted);font-size:14px;line-height:1.35;}

  .pill{
    padding:10px 14px;
    border-radius:999px;
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.15);
    font-size:13px;
    backdrop-filter:blur(8px);
    white-space:nowrap;
  }

  .grid{
    display:grid;
    grid-template-columns:1fr;
    gap:14px;
  }
  @media(min-width:920px){
    .grid{grid-template-columns:1.2fr .8fr;}
  }

  .card{
    background:rgba(10,12,18,0.55);
    border:1px solid rgba(255,255,255,.15);
    border-radius:var(--radius);
    padding:18px;
    backdrop-filter:blur(14px);
  }

  label{
    display:block;
    color:var(--muted);
    font-size:13px;
    margin:10px 0 6px;
  }

  textarea,input[type="date"]{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.15);
    background:rgba(0,0,0,.35);
    color:var(--text);
    font-family:var(--sans);
    outline:none;
  }
  textarea:focus,input[type="date"]:focus{
    border-color: rgba(255,255,255,.28);
  }

  textarea{
    min-height:260px;
    resize:vertical;
    font-family:var(--mono);
    font-size:12px;
    line-height:1.45;
  }

  /* White date selectors */
  input[type="date"]{
    background: rgba(255,255,255,0.92) !important;
    color: #111 !important;
    border: 1px solid rgba(0,0,0,0.25) !important;
    color-scheme: light;
  }
  input[type="date"]::-webkit-calendar-picker-indicator{
    filter: invert(0);
    opacity: 0.9;
    cursor: pointer;
  }

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .row>*{flex:1}

  .btnrow{
    display:flex;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }

  button{
    padding:12px 16px;
    border-radius:14px;
    border:none;
    cursor:pointer;
    font-weight:650;
    letter-spacing:.2px;
    background: var(--accentBg);
    color: var(--accentText);
  }
  button.secondary{
    background:rgba(0,0,0,.35);
    color:var(--text);
    border:1px solid rgba(255,255,255,.2);
    backdrop-filter:blur(8px);
  }
  button:active{transform: translateY(1px);}

  .error,.ok{
    margin-top:10px;
    padding:10px 12px;
    border-radius:12px;
    font-size:13px;
    display:none;
  }
  .error{
    background:rgba(255,100,100,.15);
    border:1px solid rgba(255,100,100,.4);
  }
  .ok{
    background:rgba(124,255,167,.15);
    border:1px solid rgba(124,255,167,.4);
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
    border-radius:14px;
    overflow:hidden;
    background:rgba(0,0,0,.25);
  }
  th,td{
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,.1);
    font-size:13px;
  }
  th{color:var(--muted);}
  tr:last-child td{border-bottom:none;}

  .kpi{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  .kpi .box{
    padding:12px;
    border-radius:14px;
    background:rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.12);
  }
  .kpi .t{color:var(--muted);font-size:12px;}
  .kpi .v{font-size:20px;font-weight:800;margin-top:4px;}
  .foot{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.35;}

  tr.quota-missing td{
    background: var(--rowRedBg);
    border-bottom-color: var(--rowRedBorder);
  }
  tr.quota-complete td{
    background: var(--rowGreenBg);
    border-bottom-color: var(--rowGreenBorder);
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.20);
    font-size:12px;
    color:var(--text);
    white-space:nowrap;
  }
  .badge.red{
    border-color: var(--rowRedBorder);
    background: rgba(255,90,90,0.12);
  }
  .badge.green{
    border-color: var(--rowGreenBorder);
    background: rgba(124,255,167,0.12);
  }

  /* ===== EXPORT MODAL ===== */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.65);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:999;
  }
  .modal{
    width:min(900px, 94vw);
    max-height: 86vh;
    overflow:auto;
    border-radius: 18px;
    border:1px solid rgba(255,255,255,.15);
    background: rgba(10,12,18,0.92);
    backdrop-filter: blur(14px);
    padding: 16px;
  }
  .modal h3{margin:0 0 10px 0;font-size:16px;}
  .modal .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
  .modal textarea{min-height: 320px;background: rgba(0,0,0,0.35);}
  .smallmuted{color:var(--muted);font-size:12px;margin-top:6px;}

  /* ===== PAGES ===== */
  .page{display:none;}
  .page.active{display:block;}

  /* ===== HOME: GTA-STYLE WEAPON WHEEL (ONE CIRCLE, TWO SLICES) ===== */
  .home-center{
    min-height: calc(100vh - 120px);
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .home-panel{
    width: min(980px, 100%);
    padding: 22px;
    border-radius: 24px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(10,12,18,0.45);
    backdrop-filter: blur(14px);
  }
  .home-title{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:14px;
    margin-bottom: 18px;
  }
  .home-title h1{margin:0;font-size:30px;}
  .home-title p{margin:6px 0 0;color:var(--muted);font-size:14px;}

  .wheel-wrap{
    display:flex;
    justify-content:center;
    align-items:center;
    padding: 12px 0 6px;
  }
  .wheel{
    width: min(520px, 88vw);
    aspect-ratio: 1/1;
    border-radius: 999px;
    position:relative;
    overflow:hidden;
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 30px 70px rgba(0,0,0,.45);
    background: rgba(0,0,0,.10);
  }

  .slice{
    position:absolute;
    inset:0;
    cursor:pointer;
    user-select:none;
    transition: filter .12s ease, transform .12s ease;
  }
  .slice:active{transform: scale(.995);}

  .slice.frs{
    clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
    background: radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.14), rgba(0,0,0,.10)),
                linear-gradient(135deg, #ff2b2b, #b30000);
    color:#fff;
  }

  .slice.hw{
    clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);
    background: radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.12), rgba(0,0,0,.08)),
                linear-gradient(135deg, #ffd000, #ffb300);
    color:#111;
  }

  .slice:hover{filter: brightness(1.05);}

  /* ✅ CRESTS (instead of text) */
  .crest-layer{
    position:absolute;
    inset:0;
    pointer-events:none; /* clicks go through to slices */
  }
  .crest{
    position:absolute;
    top:50%;
    transform: translateY(-50%);
    width: 118px;
    height: 118px;
    object-fit: contain;
    filter: drop-shadow(0 12px 22px rgba(0,0,0,.45));
    opacity: 0.98;
  }
  .crest.frs{
    left: 7%;
  }
  .crest.hw{
    right: 7%;
  }

  /* center hub */
  .hub{
    position:absolute;
    inset: 50% auto auto 50%;
    transform: translate(-50%,-50%);
    width: 44%;
    aspect-ratio:1/1;
    border-radius:999px;
    background: rgba(10,12,18,0.55);
    border: 1px solid rgba(255,255,255,.16);
    backdrop-filter: blur(14px);
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding: 14px;
    pointer-events:none;
  }
  .hub .hubtxt{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .hub .t1{font-weight:900; letter-spacing:.3px;}
  .hub .t2{color:var(--muted); font-size:12px; line-height:1.25;}

  /* Division themes (for buttons inside pages) */
  body.theme-frs{
    --accentBg: #ff2b2b;
    --accentText: #ffffff;
  }
  body.theme-hw{
    --accentBg: #ffd000;
    --accentText: #111111;
  }

  /* Menu button (top right inside tracker pages) */
  .menuBtn{
    padding:10px 14px;
    border-radius:999px;
  }
</style>
</head>

<body class="theme-frs">

  <!-- HOME background image -->
  <div id="homeBg" class="home-bg" aria-hidden="true"></div>

  <!-- LIVE background video (used for tracker pages) -->
  <div id="videoBgWrap" class="bg-video-wrap" aria-hidden="true" style="display:none;">
    <video id="bgVideo" class="bg-video" autoplay muted loop playsinline preload="auto">
      <source id="bgVideoSource" src="./UKFRS_website_video.mp4" type="video/mp4">
    </video>
  </div>

  <!-- HOME PAGE -->
  <div id="pageHome" class="page active">
    <div class="wrap">
      <div class="home-center">
        <div class="home-panel">
          <div class="home-title">
            <div>
              <h1>Duty Hours Tracker</h1>
              <p>Select your division to continue.</p>
            </div>
            <div class="pill">F999 System</div>
          </div>

          <div class="wheel-wrap">
            <div class="wheel" aria-label="Division selector">
              <div class="slice frs" id="goFRS" role="button" tabindex="0" aria-label="Open UKFRS"></div>
              <div class="slice hw" id="goHW" role="button" tabindex="0" aria-label="Open UKHW"></div>

              <!-- ✅ CRESTS -->
              <div class="crest-layer" aria-hidden="true">
                <img class="crest frs" src="./UKFRS_crest.jpg" alt="UKFRS crest">
                <img class="crest hw"  src="./UKHW_crest.jpg"  alt="UKHW crest">
              </div>

              <div class="hub" aria-hidden="true">
                <div class="hubtxt">
                  <div class="t1">Choose Division</div>
                  <div class="t2">Click left or right</div>
                </div>
              </div>
            </div>
          </div>

          <div class="foot" style="margin-top:14px;">
            Credits for the backrounds to <span style="font-family:var(--mono)">Charlie Glover</span>:
            <span style="font-family:var(--mono)">UKFRS_crest.jpg</span>, <span style="font-family:var(--mono)">UKHW_crest.jpg</span>,
            <span style="font-family:var(--mono)">UKFRS_website_video.mp4</span>, <span style="font-family:var(--mono)">UKHW_website_video.mp4</span>,
            and your <span style="font-family:var(--mono)">F999_photo.jpg</span>.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- UKFRS PAGE -->
  <div id="pageFRS" class="page">
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <h1>UKFRS Duty Hours</h1>
          <p>Callsigns: F1–F12. Filtered by <b>Ended</b> date.</p>
        </div>
        <button class="secondary menuBtn" id="menuFromFRS">Menu</button>
      </div>

      <div class="grid">
        <div class="card">
          <label>Duty Logger export</label>
          <textarea id="logsFRS" placeholder="Paste UKFRS logs here..."></textarea>

          <div class="row">
            <div>
              <label>Start date (inclusive)</label>
              <input type="date" id="startDateFRS">
            </div>
            <div>
              <label>End date (inclusive)</label>
              <input type="date" id="endDateFRS">
            </div>
          </div>

          <div class="btnrow">
            <button id="getHoursFRS">Get hours</button>
            <button id="exportFRS" class="secondary">Export data</button>
            <button id="clearFRS" class="secondary">Clear</button>
          </div>

          <div id="errFRS" class="error"></div>
          <div id="okFRS" class="ok"></div>
          <div class="foot" id="metaFRS"></div>
        </div>

        <div class="card">
          <div class="kpi">
            <div class="box">
              <div class="t">Quota</div>
              <div class="v">06:00</div>
            </div>
            <div class="box">
              <div class="t">Total time (all)</div>
              <div class="v" id="totalFRS">00:00</div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Callsign</th>
                <th>Total</th>
                <th>Quota status</th>
              </tr>
            </thead>
            <tbody id="rowsFRS">
              <tr><td colspan="3" style="color:var(--muted)">No results yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- UKHW PAGE -->
  <div id="pageHW" class="page">
    <div class="wrap">
      <div class="top">
        <div class="brand">
          <h1>UKHW Duty Hours</h1>
          <p>Callsigns: U1–U6 and ST7–ST10. Filtered by <b>Ended</b> date.</p>
        </div>
        <button class="secondary menuBtn" id="menuFromHW">Menu</button>
      </div>

      <div class="grid">
        <div class="card">
          <label>Duty Logger export</label>
          <textarea id="logsHW" placeholder="Paste UKHW logs here..."></textarea>

          <div class="row">
            <div>
              <label>Start date (inclusive)</label>
              <input type="date" id="startDateHW">
            </div>
            <div>
              <label>End date (inclusive)</label>
              <input type="date" id="endDateHW">
            </div>
          </div>

          <div class="btnrow">
            <button id="getHoursHW">Get hours</button>
            <button id="exportHW" class="secondary">Export data</button>
            <button id="clearHW" class="secondary">Clear</button>
          </div>

          <div id="errHW" class="error"></div>
          <div id="okHW" class="ok"></div>
          <div class="foot" id="metaHW"></div>
        </div>

        <div class="card">
          <div class="kpi">
            <div class="box">
              <div class="t">Quota</div>
              <div class="v">06:00</div>
            </div>
            <div class="box">
              <div class="t">Total time (all)</div>
              <div class="v" id="totalHW">00:00</div>
            </div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Callsign</th>
                <th>Total</th>
                <th>Quota status</th>
              </tr>
            </thead>
            <tbody id="rowsHW">
              <tr><td colspan="3" style="color:var(--muted)">No results yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- EXPORT MODAL -->
  <div id="exportBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Export data">
    <div class="modal">
      <h3>Exported shifts (copy/paste)</h3>
      <textarea id="exportText" readonly></textarea>
      <div class="smallmuted">Format: Callsign [TAB] Date (M/D/YYYY) [TAB] Time (HH:MM)</div>
      <div class="actions">
        <button id="copyExportBtn">Copy</button>
        <button id="closeExportBtn" class="secondary">Close</button>
      </div>
      <div id="copyMsg" class="smallmuted"></div>
    </div>
  </div>

<script>
(() => {
  const QUOTA_MINUTES = 6 * 60;

  // Put both video files next to index.html
  const FRS_VIDEO = "./UKFRS_website_video.mp4";
  const HW_VIDEO  = "./UKHW_website_video.mp4";

  // ========= PAGE SWITCHING =========
  const pageHome = document.getElementById("pageHome");
  const pageFRS  = document.getElementById("pageFRS");
  const pageHW   = document.getElementById("pageHW");
  const homeBg   = document.getElementById("homeBg");
  const videoBgWrap = document.getElementById("videoBgWrap");
  const bgVideo = document.getElementById("bgVideo");
  const bgVideoSource = document.getElementById("bgVideoSource");

  function tryPlayVideo(){
    if (!bgVideo) return;
    bgVideo.muted = true;
    const p = bgVideo.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
  }
  document.addEventListener("click", tryPlayVideo, { once:true });
  document.addEventListener("touchstart", tryPlayVideo, { once:true });

  function setVideoSource(src){
    if (!src) return;
    if (bgVideoSource.getAttribute("src") === src) {
      tryPlayVideo();
      return;
    }
    bgVideo.pause();
    bgVideoSource.setAttribute("src", src);
    bgVideo.load();
    tryPlayVideo();
  }

  function setActivePage(which){
    pageHome.classList.remove("active");
    pageFRS.classList.remove("active");
    pageHW.classList.remove("active");

    if (which === "home"){
      pageHome.classList.add("active");
      document.body.classList.remove("theme-frs","theme-hw");
      document.body.classList.add("theme-frs");
      homeBg.style.display = "block";
      videoBgWrap.style.display = "none";
      return;
    }

    homeBg.style.display = "none";
    videoBgWrap.style.display = "block";

    if (which === "frs"){
      pageFRS.classList.add("active");
      document.body.classList.remove("theme-hw");
      document.body.classList.add("theme-frs");
      setVideoSource(FRS_VIDEO);
      return;
    }

    if (which === "hw"){
      pageHW.classList.add("active");
      document.body.classList.remove("theme-frs");
      document.body.classList.add("theme-hw");
      setVideoSource(HW_VIDEO);
      return;
    }
  }

  const goFRS = document.getElementById("goFRS");
  const goHW  = document.getElementById("goHW");

  goFRS.addEventListener("click", () => setActivePage("frs"));
  goHW.addEventListener("click",  () => setActivePage("hw"));

  function keyActivate(el, fn){
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); fn(); }
    });
  }
  keyActivate(goFRS, () => setActivePage("frs"));
  keyActivate(goHW,  () => setActivePage("hw"));

  document.getElementById("menuFromFRS").addEventListener("click", () => setActivePage("home"));
  document.getElementById("menuFromHW").addEventListener("click",  () => setActivePage("home"));

  // ========= PARSING =========
  const ZERO_WIDTH_RE = /[\u200B-\u200D\u2060\uFEFF]/g;
  function cleanLine(s){ return String(s ?? "").replace(/\r?\n$/, "").replace(ZERO_WIDTH_RE, ""); }

  const DUTY_ENDED_RE = /\b((?:F(?:[1-9]|1[0-2]))|(?:U[1-6])|(?:ST(?:[7-9]|10)))\s*[—–-]\s*Duty\s+Ended\b/i;
  const CALLSIGN_LINE_RE = /^\s*Callsign:\s*([A-Z]{1,2}\d{1,2})\s*$/i;
  const DURATION_LINE_RE = /^\s*Duration:\s*(.+?)\s*$/i;
  const ENDED_LINE_RE    = /^\s*Ended:\s*(.+?)\s*$/i;

  const MONTHS = {
    january:0,february:1,march:2,april:3,may:4,june:5,july:6,august:7,september:8,october:9,november:10,december:11
  };

  function isValidYMD(y,m,d){
    const dt = new Date(y,m,d);
    return Number.isInteger(y) && Number.isInteger(m) && Number.isInteger(d) &&
      y>=1970 && y<=2100 && m>=0 && m<=11 && d>=1 && d<=31 &&
      dt.getFullYear()===y && dt.getMonth()===m && dt.getDate()===d;
  }

  function formatMDY(d){
    return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
  }

  function durationToMinutes(t){
    const mh = /(\d+)\s*h/i.exec(t || "");
    const mm = /(\d+)\s*m/i.exec(t || "");
    const h = mh ? Number(mh[1]) : 0;
    const m = mm ? Number(mm[1]) : 0;
    return h*60 + m;
  }
  function minutesToHHMM(t){
    const h=Math.floor(t/60), m=t%60;
    return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
  }

  function parseEndedToDate(endedText){
    let t = cleanLine(endedText).trim();
    t = t.replace(/^\[\d{1,2}:\d{2}\]\s*/, "");
    t = t.replace(/^(\d{1,2}:\d{2})([A-Za-z])/, "$1 $2");

    // Day-first (UKHW): "Sunday, 22 February 2026 21:46"
    const mA = /^(?:[A-Za-z]+(?:day)?[,\s]+)?(\d{1,2})\s+([A-Za-z]+)\s+(\d{4})\s+(\d{1,2}):(\d{2})\s*([AP]M)?\s*$/i.exec(t);
    if (mA) {
      const day = Number(mA[1]);
      const mon = MONTHS[mA[2].toLowerCase()];
      const year = Number(mA[3]);
      if (mon === undefined || !isValidYMD(year, mon, day)) return null;
      return new Date(year, mon, day);
    }

    // Month-name (UKFRS): "Thursday, January 29, 2026 10:04 PM"
    const mB = /^(?:[A-Za-z]+,\s*)?([A-Za-z]+)\s+(\d{1,2}),\s*(\d{4})\s+(\d{1,2}):(\d{2})\s*([AP]M)?\s*$/i.exec(t);
    if (mB) {
      const mon = MONTHS[mB[1].toLowerCase()];
      const day = Number(mB[2]);
      const year = Number(mB[3]);
      if (mon === undefined || !isValidYMD(year, mon, day)) return null;
      return new Date(year, mon, day);
    }

    // Numeric date with time (M/D or D/M)
    const mC = /^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})(?:\s*([AP]M))?\s*$/i.exec(t);
    if (mC) {
      const a = Number(mC[1]);
      const b = Number(mC[2]);
      const year = Number(mC[3]);
      let mo, day;
      if (a > 12) { day = a; mo = b - 1; } else { mo = a - 1; day = b; }
      if (!isValidYMD(year, mo, day)) return null;
      return new Date(year, mo, day);
    }

    const mD = /^(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})\s*$/.exec(t);
    if (mD) {
      const a = Number(mD[1]);
      const b = Number(mD[2]);
      const year = Number(mD[3]);
      let mo, day;
      if (a > 12) { day = a; mo = b - 1; } else { mo = a - 1; day = b; }
      if (!isValidYMD(year, mo, day)) return null;
      return new Date(year, mo, day);
    }

    return null;
  }

  function inputDate(el){
    const v = (el.value || "").trim(); // YYYY-MM-DD
    if (!v) return null;
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(v);
    if (!m) return null;
    const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
    if (!isValidYMD(y, mo, d)) return null;
    return new Date(y, mo, d);
  }

  function quotaCellHTML(totalMinutes){
    if (totalMinutes >= QUOTA_MINUTES) return `<span class="badge green">Quota complete</span>`;
    const remaining = QUOTA_MINUTES - totalMinutes;
    return `<span class="badge red">Remaining: ${minutesToHHMM(remaining)}</span>`;
  }

  const FRS_ALLOWED = new Set(Array.from({length:12}, (_,i)=>`F${i+1}`));
  const HW_ALLOWED  = new Set(["U1","U2","U3","U4","U5","U6","ST7","ST8","ST9","ST10"]);

  function extractRecords(logText, allowedSet){
    const lines = String(logText || "").split("\n").map(cleanLine);
    const records = [];

    let inBlock=false;
    let block_callsign=null;
    let block_minutes=null;
    let block_endedDate=null;

    function finalize(){
      if (!inBlock) return;
      if (
        block_callsign &&
        allowedSet.has(block_callsign) &&
        block_minutes != null &&
        block_minutes > 0 &&
        block_endedDate instanceof Date
      ) {
        records.push({ callsign: block_callsign, ended: block_endedDate, minutes: block_minutes });
      }
      inBlock=false; block_callsign=null; block_minutes=null; block_endedDate=null;
    }

    for (const line of lines) {
      const mStart = DUTY_ENDED_RE.exec(line);
      if (mStart) {
        finalize();
        inBlock = true;
        block_callsign = String(mStart[1] || "").toUpperCase();
        continue;
      }
      if (!inBlock) continue;

      const mCS = CALLSIGN_LINE_RE.exec(line);
      if (mCS) { block_callsign = String(mCS[1] || "").toUpperCase(); continue; }

      const mDur = DURATION_LINE_RE.exec(line);
      if (mDur) { block_minutes = durationTo_minutes(mDur[1]); continue; } // <-- fixed below
      const mEnd = ENDED_LINE_RE.exec(line);
      if (mEnd) {
        block_endedDate = parseEndedToDate(mEnd[1]);
        finalize();
        continue;
      }
    }
    finalize();
    return records;
  }

  // fix typo safely (if browser caches older JS)
  function durationTo_minutes(x){ return durationToMinutes(x); }

  function filterRecordsByRange(records, start, end){
    const out = [];
    for (const r of records){
      if (start && r.ended.getTime() < start.getTime()) continue;
      if (end && r.ended.getTime() > end.getTime()) continue;
      out.push(r);
    }
    return out;
  }

  function buildExportText(recordsInRange){
    const sorted = [...recordsInRange].sort((a,b) => {
      const da=a.ended.getTime(), db=b.ended.getTime();
      if (da !== db) return da - db;
      return a.callsign.localeCompare(b.callsign);
    });
    return sorted.map(r => `${r.callsign}\t${formatMDY(r.ended)}\t${minutesToHHMM(r.minutes)}`).join("\n");
  }

  function computeTotals(recordsInRange){
    const totals = {};
    for (const r of recordsInRange){
      totals[r.callsign] = (totals[r.callsign] || 0) + r.minutes;
    }
    return totals;
  }

  function renderTotals(totals, tbodyEl, totalEl){
    tbodyEl.innerHTML = "";
    const keys = Object.keys(totals).sort();
    if (keys.length === 0){
      tbodyEl.innerHTML = '<tr><td colspan="3" style="color:var(--muted)">No results yet.</td></tr>';
      totalEl.textContent = "00:00";
      return 0;
    }
    let grand = 0;
    for (const cs of keys){
      const mins = totals[cs];
      grand += mins;
      const tr = document.createElement("tr");
      tr.className = (mins >= QUOTA_MINUTES) ? "quota-complete" : "quota-missing";
      tr.innerHTML = `
        <td>${cs}</td>
        <td>${minutesToHHMM(mins)}</td>
        <td>${quotaCellHTML(mins)}</td>
      `;
      tbodyEl.appendChild(tr);
    }
    totalEl.textContent = minutesToHHMM(grand);
    return grand;
  }

  // ========= EXPORT MODAL =========
  const exportBackdrop = document.getElementById("exportBackdrop");
  const exportText = document.getElementById("exportText");
  const copyExportBtn = document.getElementById("copyExportBtn");
  const closeExportBtn = document.getElementById("closeExportBtn");
  const copyMsg = document.getElementById("copyMsg");

  function openExportModal(text){
    exportText.value = text || "";
    copyMsg.textContent = "";
    exportBackdrop.style.display = "flex";
    exportText.focus();
    exportText.select();
  }
  function closeExportModal(){ exportBackdrop.style.display = "none"; }

  exportBackdrop.addEventListener("click", (e) => { if (e.target === exportBackdrop) closeExportModal(); });
  closeExportBtn.addEventListener("click", closeExportModal);
  copyExportBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(exportText.value);
      copyMsg.textContent = "Copied to clipboard.";
    }catch{
      copyMsg.textContent = "Select all (Ctrl+A) then copy (Ctrl+C).";
    }
  });

  function wireDivision(opts){
    const {
      logsEl, startEl, endEl,
      btnGet, btnExport, btnClear,
      errEl, okEl, metaEl,
      rowsEl, totalEl,
      allowedSet
    } = opts;

    function show(el, msg){
      el.style.display = msg ? "block" : "none";
      el.textContent = msg || "";
    }

    btnGet.addEventListener("click", () => {
      show(errEl, ""); show(okEl, ""); metaEl.textContent = "";

      const text = logsEl.value || "";
      if (!text.trim()){
        show(errEl, "Paste logs first.");
        return;
      }

      const start = inputDate(startEl);
      const end = inputDate(endEl);
      if (start && end && start.getTime() > end.getTime()){
        show(errEl, "Start date must be on or before End date.");
        return;
      }

      const records = extractRecords(text, allowedSet);
      const inRange = filterRecordsByRange(records, start, end);
      const totals = computeTotals(inRange);

      const grand = renderTotals(totals, rowsEl, totalEl);
      metaEl.textContent = `Parsed ${records.length} Duty Ended blocks. Kept ${inRange.length} in range.`;
      show(okEl, grand > 0 ? "Done." : "No matching shifts in that range.");
    });

    btnExport.addEventListener("click", () => {
      show(errEl, ""); show(okEl, "");

      const text = logsEl.value || "";
      if (!text.trim()){
        show(errEl, "Paste logs first (then export).");
        return;
      }

      const start = inputDate(startEl);
      const end = inputDate(endEl);
      if (start && end && start.getTime() > end.getTime()){
        show(errEl, "Start date must be on or before End date.");
        return;
      }

      const records = extractRecords(text, allowedSet);
      const inRange = filterRecordsByRange(records, start, end);
      openExportModal(buildExportText(inRange));
    });

    btnClear.addEventListener("click", () => {
      logsEl.value = "";
      startEl.value = "";
      endEl.value = "";
      rowsEl.innerHTML = '<tr><td colspan="3" style="color:var(--muted)">No results yet.</td></tr>';
      totalEl.textContent = "00:00";
      show(errEl, "");
      show(okEl, "");
      metaEl.textContent = "";
      closeExportModal();
      logsEl.focus();
    });
  }

  wireDivision({
    logsEl: document.getElementById("logsFRS"),
    startEl: document.getElementById("startDateFRS"),
    endEl: document.getElementById("endDateFRS"),
    btnGet: document.getElementById("getHoursFRS"),
    btnExport: document.getElementById("exportFRS"),
    btnClear: document.getElementById("clearFRS"),
    errEl: document.getElementById("errFRS"),
    okEl: document.getElementById("okFRS"),
    metaEl: document.getElementById("metaFRS"),
    rowsEl: document.getElementById("rowsFRS"),
    totalEl: document.getElementById("totalFRS"),
    allowedSet: FRS_ALLOWED
  });

  wireDivision({
    logsEl: document.getElementById("logsHW"),
    startEl: document.getElementById("startDateHW"),
    endEl: document.getElementById("endDateHW"),
    btnGet: document.getElementById("getHoursHW"),
    btnExport: document.getElementById("exportHW"),
    btnClear: document.getElementById("clearHW"),
    errEl: document.getElementById("errHW"),
    okEl: document.getElementById("okHW"),
    metaEl: document.getElementById("metaHW"),
    rowsEl: document.getElementById("rowsHW"),
    totalEl: document.getElementById("totalHW"),
    allowedSet: HW_ALLOWED
  });

  // start at home
  setActivePage("home");
})();
</script>
</body>
</html>
